<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kidney CKD Kids ‚Äì Food Guidance</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* simple progress bar */
    .bar { height: 12px; border-radius: 999px; background: #e5e7eb; overflow: hidden; }
    .bar>span { display:block; height:100%; background: #60a5fa; }
    .chip { font-size:12px; padding:2px 8px; border-radius:999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">üçé CKD Kids ‚Äì ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï</h1>
      <nav class="flex gap-2 text-sm">
        <button class="tabBtn px-3 py-1 rounded hover:bg-slate-100" data-tab="dashboard">Dashboard</button>
        <button class="tabBtn px-3 py-1 rounded hover:bg-slate-100" data-tab="food">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        <button class="tabBtn px-3 py-1 rounded hover:bg-slate-100" data-tab="manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        <button class="tabBtn px-3 py-1 rounded hover:bg-slate-100" data-tab="profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 grid gap-6">
    <!-- Dashboard -->
    <section id="dashboard" class="tab">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white shadow rounded-xl p-4">
          <h2 class="font-semibold mb-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
          <div class="text-sm text-slate-600 mb-3" id="userSummary">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
          <div class="space-y-3">
            <div>
              <div class="flex justify-between text-sm mb-1"><span>‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (g)</span><span id="proteinLabel">0 / 0</span></div>
              <div class="bar"><span id="proteinBar" style="width:0%"></span></div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1"><span>‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° (mg)</span><span id="sodiumLabel">0 / 0</span></div>
              <div class="bar"><span id="sodiumBar" style="width:0%"></span></div>
            </div>
            <div class="text-sm" id="adviceBox"></div>
          </div>
        </div>
        <div class="bg-white shadow rounded-xl p-4">
          <h2 class="font-semibold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
          <div id="todayList" class="divide-y"></div>
          <div class="flex justify-between items-center pt-3">
            <button id="clearToday" class="text-xs text-red-600 hover:underline">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button id="exportCsv" class="text-xs text-slate-700 hover:underline">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Food Search/Add -->
    <section id="food" class="tab hidden">
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <div class="grid md:grid-cols-4 gap-2 mb-3">
          <input id="search" class="md:col-span-3 border rounded px-3 py-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏ä‡∏∑‡πà‡∏≠)" />
          <select id="categoryFilter" class="border rounded px-3 py-2">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
            <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</option>
            <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á</option>
            <option>‡∏ã‡∏≠‡∏™‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™</option>
            <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
        <div id="foodList" class="grid sm:grid-cols-2 gap-3"></div>
      </div>
    </section>

    <!-- Manage Foods -->
    <section id="manage" class="tab hidden">
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <form id="addFoodForm" class="grid md:grid-cols-5 gap-2 items-end">
          <input required id="foodName" class="border rounded px-3 py-2 md:col-span-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" />
          <select id="foodCat" class="border rounded px-3 py-2">
            <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</option>
            <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á</option>
            <option>‡∏ã‡∏≠‡∏™‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™</option>
            <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
          <input required id="foodProtein" type="number" min="0" step="0.1" class="border rounded px-3 py-2" placeholder="‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (g)" />
          <input required id="foodSodium" type="number" min="0" step="1" class="border rounded px-3 py-2" placeholder="‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (mg)" />
          <button class="bg-slate-800 text-white rounded px-4 py-2">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </form>
        <p class="text-xs text-slate-500 mt-2">* ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ = 1 ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
      </div>
    </section>

    <!-- Profile -->
    <section id="profile" class="tab hidden">
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-3">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
        <form id="profileForm" class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input id="p_name" class="border rounded w-full px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
            <input id="p_age" type="number" min="0" max="18" class="border rounded w-full px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
            <input id="p_weight" type="number" min="1" step="0.1" class="border rounded w-full px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">‡∏£‡∏∞‡∏¢‡∏∞ CKD</label>
            <select id="p_ckd" class="border rounded w-full px-3 py-2">
              <option value="2">‡∏£‡∏∞‡∏¢‡∏∞ 2</option>
              <option value="3">‡∏£‡∏∞‡∏¢‡∏∞ 3</option>
              <option value="4">‡∏£‡∏∞‡∏¢‡∏∞ 4</option>
              <option value="5">‡∏£‡∏∞‡∏¢‡∏∞ 5 / ‡∏ü‡∏≠‡∏Å‡πÑ‡∏ï (5D)</option>
            </select>
          </div>
          <div class="sm:col-span-2 flex gap-2">
            <button class="bg-slate-800 text-white rounded px-4 py-2" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
            <button id="resetAll" class="border rounded px-4 py-2" type="button">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </form>
        <div class="mt-4 text-xs text-slate-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (‡∏Å‡∏£‡∏±‡∏°/‡∏Å‡∏Å./‡∏ß‡∏±‡∏ô) ‡πÅ‡∏•‡∏∞‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° (‡∏°‡∏Å./‡∏ß‡∏±‡∏ô) ‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á AAP ‡πÅ‡∏•‡∏∞ Thai DRI ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠</div>
      </div>
    </section>
  </main>

  <footer class="max-w-4xl mx-auto p-6 text-xs text-slate-500">
    ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏ô‡∏±‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠
  </footer>

  <script>
    // --- Data & Storage Helpers ---
    const LS = {
      load: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
      save: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };
    const todayKey = () => 'log_'+new Date().toISOString().slice(0,10);

    // Sample food database (Thai‚Äëfriendly)
    const defaultFoods = [
      { id: 'rice', name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ 1 ‡∏ó‡∏±‡∏û‡∏û‡∏µ', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 2.0, sodium: 2 },
      { id: 'chicken_boil', name: '‡πÑ‡∏Å‡πà‡∏ï‡πâ‡∏° 50 ‡∏Å‡∏£‡∏±‡∏°', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 11.0, sodium: 50 },
      { id: 'egg', name: '‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏° 1 ‡∏ü‡∏≠‡∏á', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 6.0, sodium: 65 },
      { id: 'tofu', name: '‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏Ç‡∏≤‡∏ß 80 ‡∏Å‡∏£‡∏±‡∏°', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 8.0, sodium: 10 },
      { id: 'fish', name: '‡∏õ‡∏•‡∏≤‡∏≠‡∏ö 60 ‡∏Å‡∏£‡∏±‡∏°', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 12.0, sodium: 70 },
      { id: 'soy_sauce', name: '‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß 1 ‡∏ä‡πâ‡∏≠‡∏ô‡∏ä‡∏≤', cat: '‡∏ã‡∏≠‡∏™‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™', protein: 0.5, sodium: 335 },
      { id: 'instant_noodle', name: '‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Ø 1 ‡∏ã‡∏≠‡∏á (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡∏∏‡∏õ)', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', protein: 7.0, sodium: 1500 },
      { id: 'banana', name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤ 1 ‡∏•‡∏π‡∏Å', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á', protein: 1.2, sodium: 1 },
      { id: 'apple', name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏• 1 ‡∏ú‡∏•‡πÄ‡∏•‡πá‡∏Å', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á', protein: 0.3, sodium: 1 },
      { id: 'snack', name: '‡∏Ç‡∏ô‡∏°‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏ö 1 ‡∏ã‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å', cat: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á', protein: 2.0, sodium: 250 },
    ];

    const foods = LS.load('foods', defaultFoods);
    if (!LS.load('foods_inited', false)) { LS.save('foods', foods); LS.save('foods_inited', true); }

    const state = {
      profile: LS.load('profile', { name: '', age: null, weight: null, ckd: '2' }),
      log: LS.load(todayKey(), [])
    };

    function saveLog() { LS.save(todayKey(), state.log); }

    // --- Nutrition Target Rules (simplified from AAP/Thai DRI ranges by age group) ---
    function proteinRangePerKg(age){
      // returns [min,max] g/kg/day
      if (age <= 0.9) return [1.1, 1.57]; // 6-11 mo
      if (age <= 1.1) return [0.9, 1.21]; // ~12 mo
      if (age <= 3) return [0.9, 1.21];  // 2-3 yr
      if (age <= 6) return [0.85, 1.03]; // 4-6 yr
      if (age <= 12) return [0.9, 1.09]; // 7-12 yr
      if (age <= 14) return [0.8, 1.07]; // 13-14 yr
      return [0.8, 1.02];                // 15-17 yr
    }

    function sodiumRange(age){
      // returns [min,max] mg/day (Thai DRI based bands)
      if (age < 1) return [175, 550];
      if (age <= 3) return [225, 675];
      if (age <= 5) return [300, 900];
      if (age <= 8) return [325, 950];
      if (age <= 12) return [400, 1175];
      if (age <= 15) return [500, 1500];
      return [525, 1600];
    }

    function targets(){
      const age = Number(state.profile.age || 0);
      const wt = Number(state.profile.weight || 0);
      const [pMinKG, pMaxKG] = proteinRangePerKg(age);
      const pMin = wt * pMinKG;
      const pMax = wt * pMaxKG;
      const [sMin, sMax] = sodiumRange(age);
      return { pMin, pMax, sMin, sMax };
    }

    // --- UI Helpers ---
    function fmt(n, d=0){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }
    function percent(v, max){ if (!max) return 0; return Math.min(100, Math.round((v/max)*100)); }

    function renderDashboard(){
      const t = targets();
      const sums = state.log.reduce((a,r)=>({ protein:a.protein+ r.protein*r.qty, sodium:a.sodium+ r.sodium*r.qty }), {protein:0,sodium:0});
      // Labels & bars
      document.getElementById('proteinLabel').textContent = `${fmt(sums.protein,1)} / ${fmt(t.pMax,1)} g`;
      document.getElementById('sodiumLabel').textContent  = `${fmt(sums.sodium,0)} / ${fmt(t.sMax,0)} mg`;
      document.getElementById('proteinBar').style.width = percent(sums.protein, t.pMax)+"%";
      document.getElementById('sodiumBar').style.width  = percent(sums.sodium, t.sMax)+"%";

      // Advice
      const tips = [];
      if (sums.sodium > 0.8*t.sMax) tips.push('‚ö†Ô∏è ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡∏¥‡∏ô ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏ã‡∏≠‡∏™/‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Ø ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏≤‡∏≠‡∏ö/‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡πÅ‡∏ó‡∏ô');
      if (sums.protein < t.pMin*0.6) tips.push('‚ÑπÔ∏è ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°/‡πÑ‡∏Å‡πà‡∏ï‡πâ‡∏°‡πÉ‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°');
      document.getElementById('adviceBox').textContent = tips.join(' ¬∑ ');

      // Summary line
      const us = state.profile;
      const line = (us.name?`‡∏ä‡∏∑‡πà‡∏≠: ${us.name} ¬∑ `:'')+`‡∏≠‡∏≤‡∏¢‡∏∏ ${us.age??'-'} ‡∏õ‡∏µ ¬∑ ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ${us.weight??'-'} ‡∏Å‡∏Å. ¬∑ ‡∏£‡∏∞‡∏¢‡∏∞ CKD ${us.ckd}`+
        ` | ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢/‡∏ß‡∏±‡∏ô: ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ${fmt(t.pMin,1)}‚Äì${fmt(t.pMax,1)} g ¬∑ ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° ${fmt(t.sMin)}‚Äì${fmt(t.sMax)} mg`;
      document.getElementById('userSummary').textContent = line;

      // Today list
      const container = document.getElementById('todayList');
      container.innerHTML = '';
      state.log.forEach((r, idx)=>{
        const totP = r.protein*r.qty, totS = r.sodium*r.qty;
        const proteinClass = totP<=t.pMax? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const sodiumClass  = totS<=t.sMax?  'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const row = document.createElement('div');
        row.className = 'py-2 flex items-center justify-between gap-2';
        row.innerHTML = `
          <div>
            <div class="font-medium">${r.name} <span class="text-xs text-slate-500">√ó${r.qty}</span></div>
            <div class="flex gap-2 mt-1">
              <span class="chip ${proteinClass}">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ${fmt(totP,1)} g</span>
              <span class="chip ${sodiumClass}">‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° ${fmt(totS)} mg</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-sm px-2 py-1 border rounded" data-act="minus" data-idx="${idx}">‚àí</button>
            <button class="text-sm px-2 py-1 border rounded" data-act="plus" data-idx="${idx}">+</button>
            <button class="text-sm px-2 py-1 border rounded text-red-600" data-act="del" data-idx="${idx}">‡∏•‡∏ö</button>
          </div>`;
        container.appendChild(row);
      });
    }

    // Food list rendering
    function renderFoodList(){
      const list = document.getElementById('foodList');
      const q = document.getElementById('search').value.trim().toLowerCase();
      const cat = document.getElementById('categoryFilter').value;
      list.innerHTML = '';
      foods
        .filter(f => (!q || f.name.toLowerCase().includes(q)) && (!cat || f.cat===cat))
        .forEach(f => {
          const card = document.createElement('div');
          card.className = 'border rounded-lg p-3 hover:shadow-sm bg-white';
          // Determine image srcs
          const jpg = `images/${f.id}.jpg`;
          const png = `images/${f.id}.png`;
          const noImg = 'images/no-image.jpg';
          card.innerHTML = `
            <div class="flex gap-3 items-center sm:items-start">
              <div class="flex-shrink-0">
                <img src="${jpg}" alt="${f.name}" class="w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-md border" onerror="this.onerror=null;this.src='${png}';this.onerror=function(){this.src='${noImg}';}" />
              </div>
              <div class="flex-1">
                <div class="font-medium text-sm">${f.name}</div>
                <div class="text-xs text-slate-600 mt-1">‡∏´‡∏°‡∏ß‡∏î: ${f.cat}</div>
                <div class="text-sm mt-2">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô <b>${fmt(f.protein,1)}</b> g ¬∑ ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° <b>${fmt(f.sodium)}</b> mg / ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</div>
                <div class="mt-3 flex items-center gap-2">
                  <input type="number" min="1" value="1" class="qty border rounded px-2 py-1 w-20" />
                  <button class="add bg-slate-800 text-white rounded px-3 py-1" data-id="${f.id}">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
              </div>
            </div>`;
          list.appendChild(card);
        });
    }

    // Events
    document.querySelectorAll('.tabBtn').forEach(btn=>btn.addEventListener('click', ()=>{
      const target = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(s=>s.classList.add('hidden'));
      document.getElementById(target).classList.remove('hidden');
      if(target==='food') renderFoodList();
      if(target==='dashboard') renderDashboard();
    }));

    document.getElementById('profileForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      state.profile = {
        name: document.getElementById('p_name').value.trim(),
        age: Number(document.getElementById('p_age').value),
        weight: Number(document.getElementById('p_weight').value),
        ckd: document.getElementById('p_ckd').value
      };
      LS.save('profile', state.profile);
      renderDashboard();
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß');
    });

    document.getElementById('resetAll').addEventListener('click', ()=>{
      if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)?')){
        localStorage.clear();
        location.reload();
      }
    });

    document.getElementById('food').addEventListener('click', (e)=>{
      if(e.target.classList.contains('add')){
        const id = e.target.dataset.id;
        const card = e.target.closest('div');
        const qty = Number(card.querySelector('.qty').value || 1);
        const item = foods.find(f=>f.id===id);
        state.log.push({ name: item.name, protein: item.protein, sodium: item.sodium, qty });
        saveLog();
        renderDashboard();
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
      }
    });

    document.getElementById('search').addEventListener('input', renderFoodList);
    document.getElementById('categoryFilter').addEventListener('change', renderFoodList);

    document.getElementById('todayList').addEventListener('click', (e)=>{
      const idx = Number(e.target.dataset.idx);
      const act = e.target.dataset.act;
      if(act==='del'){ state.log.splice(idx,1); }
      if(act==='plus'){ state.log[idx].qty++; }
      if(act==='minus'){ state.log[idx].qty = Math.max(1, state.log[idx].qty-1); }
      saveLog();
      renderDashboard();
    });

    document.getElementById('clearToday').addEventListener('click', ()=>{
      if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ state.log = []; saveLog(); renderDashboard(); }
    });

    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const rows = [['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü (g)','‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü (mg)','‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏° (g)','‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏£‡∏ß‡∏° (mg)']];
      const d = new Date().toISOString().slice(0,10);
      state.log.forEach(r=> rows.push([d, r.name, r.qty, r.protein, r.sodium, (r.protein*r.qty).toFixed(1), (r.sodium*r.qty)]));
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ckd_kids_${d}.csv`;
      a.click();
    });

    document.getElementById('addFoodForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const f = {
        id: 'u_'+Date.now(),
        name: document.getElementById('foodName').value.trim(),
        cat: document.getElementById('foodCat').value,
        protein: Number(document.getElementById('foodProtein').value),
        sodium: Number(document.getElementById('foodSodium').value)
      };
      foods.push(f);
      LS.save('foods', foods);
      e.target.reset();
      alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
      renderFoodList();
    });

    // Init populate profile inputs
    (function init(){
      const p = state.profile;
      document.getElementById('p_name').value = p.name || '';
      document.getElementById('p_age').value = p.age ?? '';
      document.getElementById('p_weight').value = p.weight ?? '';
      document.getElementById('p_ckd').value = p.ckd || '2';
      renderDashboard();
      renderFoodList();
    })();
  </script>
</body>
</html>
